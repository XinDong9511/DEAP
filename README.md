# DEAP

## Introducton

Differential Expression Analysis Pipeline(DEAP) is a pipeline which can handle expression data that RNA-seq or MicroArray experiment generated. The pipeline is built using [snakemake](https://bitbucket.org/snakemake/snakemake/wiki/Home) which allows for ease of use, optimal speed, and a highly modular code that can be further added onto and customized by experienced users. 

## Usage
```{bash}
git clone git@github.com:XinDong9511/DEAP.git
cd DEAP
conda env create -n DEAP -f environment.yaml
conda activate DEAP
cd ..
cp DEAP/metasheet.csv .
cp DEAP/ref.yaml .
cp config.yaml .
mkdir data
```

Then your folder structure should like this:  

data  *(store your data)  
DEAP *(this one is the git repo)*  
metasheet.csv  
ref.yaml  
config.yaml  

After modified yaml files and metasheet.csv, at last type:
```
snakemake -s DEAP/DEAP.snakefile
```

### Files format:

- config.yaml: 
Here are several keys in this yaml file.   
`metasheet`: a path for a table file that defined the relationship among samples.   
`ref`: a yaml file that stored the path where reference files are.   
`aligner`: the align tool that you want to use for RNA-seq samples, options: `"STAR"` or `"salmon"`.   
`assembly`: the assembly you want to use for your data, options: `"mm10"` or `"hg38"`.   
`trim`: DEAP use [trim_galore](https://github.com/FelixKrueger/TrimGalore) to cut off the adaper at the distal of reads and do quality control, options: `True` or `False`.   
`check_compare`: options: `True` or `False`, when set `True` for this option, DEAP will check comparison relationship and won't process alignment for RNA-seq samples that do not have enough samples(at least 2 samples in one condition). When set `False`, DEAP will continue processing trimming adaptor and alignment but still won't do comparison.
`samples`: Should have many keys of samples and in each key, you could write one fastq file for single-end smaples or two fastq files for pair-end samples. For microarray, you could set a path that include all CEL files.  

- metasheet.csv:  
This is a table that defined samples relationship and define how you would like to do differential expression genes among samples.  
**The first column(run)** is the run name that you could define. For RNA-seq, a run(or batch) of RNA-seq samples should share same name though they could be devided into several rows for different fastq files. For microarray data, you only need set one row for a batch of data.  
**The second column(sample)** should always be samples, this should be some kinds of sample ID. This sample ID **must** match the sample names in the config yaml file.   
**The third column(experment_type)** defined the experiment type of data {RS, MA_A, MA_O, MA_I}.RS for RNA-seq, MA_{} for microarry data generated by **A**ffymatrix, **O**ligo or **I**llumina.  
**The fourth(condition) and fifth colunms(treatment)**: for RNA-seq, you could write some comments for data. For microarray samples, you are supposed to specify a path of file that include sample information at fourth column and a path for GPL file at fifth column. The files format is addressed below.  
**The sixth column(replicates)**: ONLY FOR RNA-seq sample: mark repelicate for RNA-seq samples.  
**The seventh column(compare_XXX)**: The samples that you want to perform a Differential Expression on using limma and DEseq should be marked by the “compare_” columns more on this below. The “control” should be marked with a 1, and the “treatment” should be marked with a 2. You are allowed to have as many “compare_XXXX” columns as you want at the end.  
 
- ref.yaml:  
Here you are allowed to define your own reference files. Basically here is hg38 and mm10 index files included.  

- microarray design matrix:  
This file should have 3 columns at least:  
```
sample,treatment,compare_
```
First column is the sample files name prefix, second column is the samples annotation, third column is same to metasheet seventh column which “control” should be marked with a 1, and the “treatment” should be marked with a 2. Same as `metasheet.csv`, you are allowed to append as many “compare_XXXX” columns as you want at the end.  

Here is an example at below:  
```
sample,treatment,compare_1,compare_2
GSM304304,K562_cells_control,1,1
GSM304303,K562_cells_control,1,1
GSM304479,K562_cells_control,1,1
GSM304483,K562_cells,2,
GSM304484,K562_cells,2,
GSM304486,K562_cells,2,
GSM304487,K562_cells_CREB_KO,,2
GSM304488,K562_cells_CREB_KO,,2
GSM304489,K562_cells_CREB_KO,,2
```
which means `K562_cells_control` vs. `K562_cells` and `K562_cells_control` vs. `K562_cells_CREB_KO`.  
At last, you should specify this files path in `metasheet.csv`'s fourth column.

## Appendix
